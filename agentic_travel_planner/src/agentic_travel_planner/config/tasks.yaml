i_planning_task:
  description: >
    You are the 'Chief of Staff' managing a new trip request. Your first job is to
    analyze the user's request and create a high-level plan.
    
    User Request Details:
    - Source: {source}
    - Destination: {destination}
    - Start Date: {start_date}
    - End Date: {end_date}
    - Travelers: {num_travelers}
    - Total Budget: {budget}
    - Interests: {interests}
    - Group Category: {group_category} 
    - Currency: {currency}

    You will ask the budgeting agent to break down the {budget} into three (3) allocated budgets:
    1. 'flight_budget' (Priority)
    2. 'hotel_budget' (Secondary)
    3. 'activity_budget' (Least Priority)
    and get back the allocated budgets.
    
    You must also pass this along with all other original request details for the crew.

  agent: Budgeting_Agent
  expected_output: >
    A JSON object string containing the initial plan. This JSON MUST include:
    'destination', 'start_date', 'end_date', 'num_travelers', 'group_category', 
    'interests', 'budget', 'allocated_flight_budget',
    'allocated_hotel_budget', 'currency' and 'allocated_activity_budget'.
  context: []
  output_file: output/initialplan.json

flight_research_task:
  description: >
    Find the most optimal flights. You MUST adhere to the
    'allocated_flight_budget' provided by your manager in the initial plan.
    
    **Budget Rule:** 1. Your target is the 'allocated_flight_budget'.
    2. However, if the best available flight exceeds this allocation, you are authorized to use the TOTAL TRIP BUDGET ({budget}) to secure the flight, PROVIDED that you leave at least 40% of the total budget remaining for hotels and activities.
    3. Do NOT fail the task just because the allocation is too low. If a valid flight exists within the Total Budget, book it!
    
    You must look flights between the {start_date} and {end_date}. You are not allowed to search fights out of the given travel dates.

    Search Criteria:
    - From: {source}'s airport IATA code
    - To: {destination}'s airport IATA code
    - Departure: STRICLY on {start_date} from {source} to {destination}
    - Return: STRICLY on {end_date} from {destination} to {source} (when booking return flights)
    - Travelers: {num_travelers}
    - Group Category: {group_category}
    - Currency: {currency}

    You must use your `FlightSearchTool` two times. First time for outbound flight 
    and second time for return flight. When searching for return flight remember that
    source becomes destination and destination becomes source. When searching for flights,
    you must consider the group category, available discounts and the user's preferences if
    available. Based on each search result, you must select the optimal flight option and add
    the details in the output file. If you find flights, report the details of the optimal flight.
    If no flights are found within budget, you MUST report this failure clearly so the manager can re-plan.
    If there are discounts available, you must report them.
  
  agent: Flight_Researcher
  expected_output: >
    You MUST return a JSON strictly matching `FlightResearchTaskOutput`.
    A single FlightSummary ALWAYS represents a FULL ROUND-TRIP for all travelers.
    All four datetime fields MUST be filled if returned by the tool.

    Required structure:
    {
    "source": "<IATA or city>",
    "destination": "<IATA or city>",
    "start_date": "YYYY-MM-DD",
    "end_date": "YYYY-MM-DD",
    "num_travelers": <int>,

    "flights": [
      {
        "outbound_airline": "<string>", //Required
        "outbound_flight_number": "<string or N/A>", //Required
        "outbound_departure_time": "<ISO8601 outbound departure>",        // REQUIRED
        "outbound_arrival_time": "<ISO8601 outbound arrival>",            // REQUIRED
        "outbound_flight_booking_url": "<optional link>",
        "discount_info_outbound": "<optional>",
        "return_airline": "<string>", //Required
        "return_flight_number": "<string or N/A>", //Required
        "return_departure_time": "<ISO8601 return departure>",   // REQUIRED
        "return_arrival_time": "<ISO8601 return arrival>",       // REQUIRED
        "return_flight_booking_url": "<optional link>",
        "discount_info_return": "<optional>"
        "total_price": <number>,                                 // MUST be round-trip price for all travelers
      }
    ],

    "selected_flight_total": <same as flights[0].total_price>,
    "currency": "<ISO>",
    
    // CRITICAL: Calculate remainder from the TOTAL budget ({budget}), not the allocated one.
    "updated_remaining_budget": <{budget} - selected_flight_total>
    }

    Rules:
    - One FlightSummary = entire round trip.
    - You MUST extract outbound + return timestamps from the FlightSearchTool results.
    - Never output null for departure/arrival times if the tool provides them.
    - total_price MUST include: outbound + return + all travelers.
    - Do NOT create separate flight entries for outbound and return legs.
    - Only flights within budget (or within the variance rules allowed above) are allowed.

  context:
    - i_planning_task
  output_file: output/flight_research.json

hotel_research_task:
  description: >
    Find the best-value, highly-rated hotel options that offer the best balance of safety, 
    proximity to key attractions and comfort. You MUST use the
    'updated_remaining_budget' from the flight task's output as your total available budget.
    (Note: This budget MUST cover both the hotel AND the activities).
    
    You must look hotel between the {start_date} and {end_date}.
    
    Search Criteria:
    - City: {destination}
    - Check-in: {start_date}
    - Check-out: {end_date}
    - Guests: {num_travelers}
    - User Interests (for location): {interests}
    - Group Category: {group_category} 
    
    You must use your `HotelSearchTool`. Hotels should be budget friendly and highly rated for stays.
    The chosen hotel must provide best value for money to the traveller. If no suitable hotels
    are found within the `hotel_budget`, you MUST report this failure clearly than overspending.
    so the manager can re-plan. 

  agent: Hotel_Researcher
  expected_output: >
    A JSON object string containing two keys:
    1. 'hotels': A list of hotel details (e.g., name, address, total_cost, booking_url).
       If no hotels are found, this must be an error message from your tool.
    2. 'updated_remaining_budget': A float calculated by
       (previous_remaining_budget - actual_hotel_cost).
  context:
    - flight_research_task
    - i_planning_task
  output_file: output/hotel_research.json

activity_planning_task:
  description: >
    Plan a schedule of activities based on user interests and the
    *final* remaining budget.
    
    Planning Criteria:
    - Location: {destination}
    - Interests: {interests}
    - Budget: You MUST use the 'updated_remaining_budget' from the hotel task's output.
    - Group Category: {group_category}

    You must use your `ActivitySearchTool`. Find tours, restaurants,
    or museum tickets etc that match the interests and budget.
  agent: Activity_Booker
  expected_output: >
    A JSON object string containing two keys:
    1. 'activities': A list of activity details (e.g., name, description, cost, location).
       If no activities are found, this must be an error message.
    2. 'final_remaining_budget': A float calculated by
       (previous_remaining_budget - total_activity_cost).
  context:
    - hotel_research_task
  output_file: output/activitiy_planning.json

final_assembly_task:
  description: >
    Assemble all the confirmed flight, hotel, and activity data from the
    specialist agents into a single, coherent, day-by-day itinerary.
    
    You must:
    1. Gather the outputs from `flight_research_task`, `hotel_research_task`,
       and `activity_planning_task`.
    2. If any specialist reported a failure that could not be resolved
       (and your re-planning attempts failed), you must report this
       impossibility clearly.
    3. If all parts are successful, compile them into the 'FinalItinerary'
       Pydantic model.
    4. Calculate the 'total_cost' (flights + hotel + activities) and the
       'remaining_budget' using the Budgeting_Agent's calculation:
       - Use the Budgeting_Agent's JSON output where
         'total_cost' is the sum of all components and
         'variance' = (original trip budget - total_cost).
       - Set FinalItinerary.total_cost = Budgeting_Agent.total_cost.
       - Set FinalItinerary.remaining_budget = Budgeting_Agent.variance
         (this may be negative if the trip overspends the budget).

  expected_output: >
    Return a PURE JSON string (no backticks, no markdown, no prose) that strictly matches FinalItinerary Pydantic model.
  agent: Budgeting_Agent
  context:
    - flight_research_task
    - hotel_research_task
    - activity_planning_task
  output_file: output/FinalItinerary.json